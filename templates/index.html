<!DOCTYPE html>
<html lang='ru'>
	<head>
		<meta name='viewport' content='width=device-width,initial-scale=1.0'/>
		<title>Радио Рапорт</title>
		<style>
			.fields {
				display:flex;
				width: 300vh;
			}
			.fields input {
				display: block;
			}
			p::first-letter {
				color: red;
				font-size:1.1em;
			}
		</style>
	</head>
	<body>
		<div id='top'>
			<p>Дополнительная информация имеется в консоле браузера</p>
			<p></p>
		</div>
		<!-- CRUD -->
		<div class='fields'>
			<section id='create'>
				<form id='createForm'>
				<fieldset id='qsofield'>
					<legend>Добавить QSO</legend>
					<label for='callsignInputA_create'>Первый позывной: </label><input id='callsignInputA_create' placeholder='позывной первого'/>
					<label for='callsignInputB_create'>Второй позывной: </label><input id='callsignInputB_create' placeholder='позывной второго'/>
					<label for='RSTA_create'>RST первого: </label><input id='RSTA_create' placeholder='RST A'/>
					<label for='RSTB_create'>RST второго: </label><input id='RSTB_create' placeholder='RST B'/>
					<button type='button' id='addQSOButton'>Добавить</button>
				</fieldset>
				</form>
			</section>
			<section id='read'>
				<form id='readForm'>
					<fieldset id='readfield'>
						<legend>Получить последние QSO</legend>
						<label for='qsoLimit'>Лимит: </label><input id='qsoLimit' placeholder='Limit' />
						<label for='qsoOffset'>offset: </label><input id='qsoOffset' placeholder='Offset' />
						<button id='readButton' type='button'>Получить</button>
					</fieldset>
				</form>
			</section>
			<section id='update'>
				<form id='updateForm'>
					<fieldset id='updatefield'>
					<legend>изменить QSO</legend>
					<label for='qsoUpdateID'>ID: </label><input id='qsoUpdateID' placeholder='qsoUpdateID'/>
					<label for='callsignUpdateInputA'>Первый позывной: </label><input id='callsignUpdateInputA' placeholder='позывной первого'/>
					<label for='callsignUpdateInputB'>Второй позывной: </label><input id='callsignUpdateInputB' placeholder='позывной второго'/>
					<label for='RSTUpdateA'>RST первого: </label><input id='RSTUpdateA' placeholder='RST A'/>
					<label for='RSTUpdateB'>RST второго: </label><input id='RSTUpdateB' placeholder='RST B'/>
					<button type='button' id='modifyQSO'>Изменить</button>
					</fieldset>
				</form>
			</section>
			<section id='delete'>
				<form id='deletefield'>
					<fieldset id='updatefield'>
					<legend>изменить QSO</legend>
					<label for='qsoDeleteID'>ID: </label><input id='qsoDeleteID' placeholder='qsoID'/>
					<button type='button' id='delQSO'>Удалить</button>
					</fieldset>
				</form>
			</section>
			<script>
				const delButton = document.getElementById('delQSO')
				const updateButton = document.getElementById('modifyQSO')
				const readButton = document.getElementById('readButton')
				const addButton = document.getElementById('addQSOButton')
				/* DEL BUTTON logic*/
				delButton.onclick = async () => {
					const qsoID = parseInt(document.getElementById('qsoDeleteID').value);
					if(qsoID < 0) {
						return alert("Плохой ID")
					}
					// XSS?
					const res = await fetch(`/api/QSOdel/${qsoID}`,
					{
						method: "DELETE"
					})
					if (res.ok) {
						res.json().then((js) => {
							console.log(js)
						})
					} else {
						alert("del qso err")
						console.log(res)
					}
					/* TODO: удалить запись */
				}
				/*update button logic*/
				updateButton.onclick = async() => {
					/* TODO: обновить запись */
						const qsoID = parseInt(document.getElementById('qsoUpdateID').value);
						if(qsoID < 0) {
							return alert("Плохой ID")
						}
						const data = {
							qsoUpdateID: qsoID,
					        callsignA: document.getElementById("callsignUpdateInputA").value,
					        callsignB: document.getElementById("callsignUpdateInputB").value,
					        RSTA: document.getElementById("RSTUpdateA").value,
					        RSTB: document.getElementById("RSTUpdateB").value,
					    };
					    const res = await fetch(`/api/QSOPut/${qsoID}`, {
					        method: 'PUT',  
					        headers: {
					            'Content-Type': 'application/json',  
					        },
					        body: JSON.stringify(data) 
					    });
					    if(!res.ok) {
					    	console.log(res)
					    	return alert("Ошибка в изменение")
					    }
					    res.json().then((js) => {
					    	console.log(js)
					    })
				}
				/* Add button logic */
				addButton.onclick = async () => {
					console.log("add record")
					    const data = {
					        callsignA: document.getElementById("callsignInputA_create").value,
					        callsignB: document.getElementById("callsignInputB_create").value,
					        RSTA: document.getElementById("RSTA_create").value,
					        RSTB: document.getElementById("RSTB_create").value,
					    };
					    try {
					    	const res = await fetch("/api/addQSO", {
					    		method: "POST",
					    		headers: {
					    			"Content-Type": "application/json"
					    		},
					    		body: JSON.stringify(data)
					    	})
					    	if (res.ok) {
					    		const resJson = res.json().then( (js) => {
					    			console.log(js)
					    			if(js.error) {
					    				alert(`Ошибка: ${js.error}`)
					    			} else {
					    				alert("QSO Добавлено")
					    			}
					    		})
					    	} else {
					    		console.log(res)
					    		alert("Ошибка при добавление QSO")
					    	}
					    }catch(error) {
					    	console.err(error)
					    }
				} /* end  add button logic */
				readButton.onclick = async () => {
					//XSS?
					limit = document.getElementById('qsoLimit').value
					offset = document.getElementById('qsoOffset').value
					const res = await fetch(`/api/QSO?limit=${limit}&offset=${offset}`, {
						method: "GET",
					})
					if (res.ok) {
						res.json().then( (js) => {
							console.log(`JS: ${js}`)
							console.log(js)
						})
					} else {
						console.log(`[errget]: ${res}`)
					}
				}
			</script>
		</div>
	</body>
</html>